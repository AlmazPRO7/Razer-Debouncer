# Архитектура и структура

Проект — низкоуровневый фильтр клавиатурных событий для Windows, подавляющий дребезг и корректирующий поведение автоповтора. Реализован как один исполняемый Python‑скрипт с системным LowLevel‑Hook, плюс вспомогательные утилиты и документация. Сборка в один EXE выполняется PyInstaller.

## Входные точки и сборка
- `bw3_debounce3.py` — актуальная основная точка входа (запуск/логика/трей/CLI).
- `bw3_debounce2.py` — предыдущая ревизия (исторически, для сравнения/отладки).
- `bw3_debounce.spec` — сценарий сборки PyInstaller (onefile, иконка/ресурсы при необходимости).

## Дерево каталогов (основное)
- `build/` — служебные файлы сборки (генерируется PyInstaller).
- `dist/` — артефакты сборки (готовые исполняемые файлы).
- `docs/` — документация проекта.
- `agents/` — регламенты и чек‑листы ролей.
- `scripts/` — вспомогательные скрипты (установка, запуск, git‑обёртки, анализ логов).

## Системные файлы (Windows, %APPDATA%)
- `bw3_chatter.log` — основной лог работы фильтра (ротируемый).
- `bw3_chatter_cfg.json` — пороги per‑key (ключ `"<scanCode>[:<extended>]" → seconds`). Совместимость со старым форматом без `:extended` сохранена.
- `bw3_chatter_prefs.json` — пользовательские предпочтения (например, тема трея).

## Поток событий (клавиатура)
1) WinAPI LowLevel‑Hook перехватывает события `WM_KEYDOWN/WM_KEYUP`.
2) Для каждого события вычисляются интервалы: от последнего разрешённого `DOWN`, от первого `DOWN` (удержание), от последнего `UP` и т.д.
3) До начала системного автоповтора (`repeatDelay`) блокируется только явный дребезг per‑key; повторы до `repeatDelay` вне аккордов блокируются.
4) После старта автоповтора допускаются повторы не чаще `repeat_min ± repeat_jitter`, кроме клавиш в `--no-rate-limit-vks` (напр., Backspace VK=8).
5) Аккорды модификаторов (Ctrl/Shift/Alt/Win + X):
   - Для самих модификаторов применяется узкое окно дребезга (`--mod-bounce`).
   - Первый `DOWN` немодификаторной клавиши после зажатого/недавнего модификатора может миновать пост‑UP защиту (ускорение аккордов), если не задан `--no-chord-bypass`.
   - Физическое состояние модификаторов уточняется через `GetAsyncKeyState` (отключается `--no-mod-phys-check`).
6) Пост‑UP защита: первый `DOWN` после `UP` может блокироваться в адаптивном окне (настраивается `--post-up-guard`, `--up-guard-max`, `--up-guard-step`).
7) Ранние `UP` игнорируются, если физически клавиша всё ещё нажата (`--up-bounce`, `--down-guard`).

События и решения логируются (ключевые теги: `BLOCK_*`, `REPEAT*`, `CHORD_*`). Для визуальной диагностики используется трей‑иконка с индикаторами активности.

## Конфигурация и адаптация
- Базовое окно дребезга: `--ms` (мс). Индивидуальные пороги клавиш хранятся в `%APPDATA%/bw3_chatter_cfg.json` как числа секунд.
- Адаптация пер‑клавиша: при повторяющихся блокировках порог увеличивается ступенями до предела.
- Совместимость ключей: `"<scanCode>:<extended>"` имеет приоритет; при отсутствии используется старый ключ `"<scanCode>"`.

## Единственный экземпляр
На Windows используется `CreateMutexW` для блокировки второго процесса. Флаг `--allow-multiple` отключает защиту (для отладки).

## Трей‑интерфейс
- Иконка в системном трее (pystray):
  - Пульс активности (синий — повторы, красный — блокировки, жёлтый — ранние `UP`).
  - Счётчик блокировок за последние ~60 секунд.
  - Переключение темы (light/dark), сохранение в `bw3_chatter_prefs.json`.
- Контекстное меню: выход, переключение темы, возможно — переход к логу/конфигу.

## Принципы и ограничения
- Минимальные точечные изменения; совместимость с системным автоповтором.
- Не нарушать сочетания модификаторов; приоритет отзывчивости.
- Нет внешнего CI/CD; сборка и проверка — локально.

## Дальнейшие шаги
- Выделение общих частей в модули при росте кода.
- Расширение самотестов и юнит‑покрытия.
- Экспорт/импорт профилей порогов.

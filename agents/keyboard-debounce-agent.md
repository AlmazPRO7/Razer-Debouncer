# Keyboard Debounce Agent — Техническая спецификация

Цель: поддерживать идеальную работу подавления дребезга и корректного автоповтора на Windows для проблемных клавиатур.

## Ответственности
- Анализ логов (`%APPDATA%/bw3_chatter.log`) и обратной связи.
- Корректировка алгоритма в `bw3_debounce3.py` (per‑key пороги, пост‑UP защита, авто‑повтор).
- Калибровка проблемных клавиш и сохранение порогов в `%APPDATA%/bw3_chatter_cfg.json`.
- Поддержка UI (трей‑иконка, настройки), документации и CHANGELOG.

## Ключевая логика (в коде уже реализовано)
- Первый DOWN пропускается мгновенно (для аккордов).
- До системной `repeatDelay` — отсекается реальный дребезг per‑key (адаптивные пороги).
- После начала автоповтора — пропуск DOWN с периодом ≥ `repeat_min - repeat_jitter`.
- Модификаторы (Ctrl/Shift/Alt/Win): узкое окно дребезга, без пред‑повторной задержки.
- Пост‑UP защита «первого» последующего DOWN (адаптивное окно per‑key).
- Ранние UP игнорируются, если физически клавиша всё ещё нажата (проверка `GetAsyncKeyState`).

## Регулируемые параметры (CLI)
- `--ms`: базовое окно дребезга (мс).
- `--repeat-delay`: задержка автоповтора (мс), по умолчанию — системная.
- `--repeat-min`: минимальный интервал повтора (мс), по умолчанию — из системного KeyboardSpeed.
- `--repeat-jitter`: допуск на джиттер (мс), по умолчанию 5.
- `--mod-bounce`, `--post-up-guard`, `--up-bounce`, `--down-guard`, `--up-guard-max`, `--up-guard-step`.

## Диагностика и верификация
- Удержание Backspace/стрелок/Del/Tab — отсутствие «затыков», стабильная скорость.
- Аккорды с модификаторами — мгновенный отклик.
- Отсутствие ложных повторов при одиночных быстрых нажатиях.
- Логи: наличие событий `REPEAT`, отсутствие «залипаний» `BLOCK_RATE` при нормальном удержании.

## Чек‑лист перед коммитом
- [ ] Воспроизводимость бага подтверждена/исправлена.
- [ ] Нет регрессий в сочетаниях модификаторов.
- [ ] Обновлён CHANGELOG, при необходимости — docs.
- [ ] Параметры по умолчанию не ухудшают поведение на «здоровых» клавиатурах.

## Идеи для улучшений
- Порог per‑key с EMA по фактическим интервалам дребезга.
- Автосброс усиленных порогов после N дней без дребезга.
- Экспорт/импорт профилей порогов.

